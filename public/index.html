<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C칙meras do Rio de Janeiro</title>
    <meta name="author" content="Rafael Bravo">
    <!-- Google Tag Manager -->
    <script>(function (w, d, s, l, i) {
            w[l] = w[l] || []; w[l].push({
                'gtm.start':
                    new Date().getTime(), event: 'gtm.js'
            }); var f = d.getElementsByTagName(s)[0],
                j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : ''; j.async = true; j.src =
                    'https://www.googletagmanager.com/gtm.js?id=' + i + dl; f.parentNode.insertBefore(j, f);
        })(window, document, 'script', 'dataLayer', 'GTM-MP4339CX');</script>
    <!-- End Google Tag Manager -->
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-MZP06CBV83"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-MZP06CBV83');
    </script>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .vbox {
            display: flex;
            flex-direction: column;
        }

        header {
            background: linear-gradient(315deg, #595959 0%, #121212 100%);
            color: white;
            padding: 12px 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        header h1 {
            font-size: 24px;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        header .info {
            font-size: 14px;
            opacity: 0.9;
        }

        header .github-link {
            display: flex;
            align-items: center;
            gap: 6px;
            color: white;
            text-decoration: none;
            padding: 8px 12px;
            border-radius: 6px;
            transition: all 0.3s ease;
            background: #222222;
        }

        header .github-link:hover {
            background: #333333;
            transform: translateY(-2px);
        }

        header .github-link svg {
            width: 20px;
            height: 20px;
        }

        .bairro-selector {
            padding: 8px 0;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px 20px;
        }

        .bairro-selector label {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .bairro-selector select {
            flex: 1;
            max-width: 300px;
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .bairro-selector select:hover {
            border-color: #1f54b8;
        }

        .bairro-selector select:focus {
            outline: none;
            border-color: #1f54b8;
            box-shadow: 0 0 0 3px rgba(31, 84, 184, 0.1);
        }

        #map {
            flex: 1;
            width: 100%;
        }

        .camera-popup {
            text-align: center;
            min-width: 600px;
            height: 400px;
        }

        .camera-content {
            padding: 0 10px;
        }

        .camera-popup h3 {
            margin-bottom: 10px;
            color: #333;
            font-size: 16px;
        }

        .camera-popup iframe {
            width: 1940px;
            max-width: 1940px;
            height: 1080px;
            min-height: 550px;
            /* zoom: 0.4; */
            transform: scale(0.29);
            transform-origin: 0 0;
            margin: 8px;
        }

        .leaflet-popup-content {
            margin: 8px;
            min-width: 260px;
            max-width: 90vw;
            overflow: hidden;
        }

        .leaflet-popup-content-wrapper {
            border-radius: 12px;
        }

        /* 칈cone customizado para c칙mera */
        .camera-icon {
            background: #1f54b8;
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        /* Media Queries para Mobile */
        @media (max-width: 768px) {
            header {
                padding: 10px 15px;
            }

            header h1 {
                font-size: 18px;
            }

            header .info {
                font-size: 12px;
            }

            header .github-link span {
                display: none;
            }

            header .github-link {
                padding: 6px;
            }

            .bairro-selector {
                flex-direction: column;
                align-items: stretch;
                gap: 6px;
                padding: 10px 15px;
            }

            .bairro-selector label {
                font-size: 12px;
            }

            .bairro-selector select {
                max-width: 100%;
                font-size: 13px;
            }

            .camera-content {
                padding: 0 5px;
            }

            .camera-popup {
                min-width: 280px;
                max-width: 100%;
                max-width: 345px;
                max-height: 250px;
            }

            .camera-popup h3 {
                font-size: 14px;
            }

            .camera-popup iframe {
                width: 1950px;
                max-width: 1950px;
                height: 1120px;
                min-height: 550px;
                /* zoom: 0.4; */
                transform: scale(0.14);
                transform-origin: 0 0;
                margin: 8px;
            }

            .leaflet-popup-content {
                margin: 8px;
                min-width: 260px;
                max-width: 90vw;
                height: 250px;
                overflow: hidden;
            }
        }

        @media (max-width: 480px) {
            header {
                padding: 8px 12px;
                flex-direction: row;
                align-items: center;
                gap: 4px;
            }

            header h1 {
                font-size: 16px;
            }

            header .info {
                font-size: 11px;
            }

            .camera-popup {
                min-width: 360px;
                max-height: 260px;
                overflow: hidden;
            }

            .camera-popup h3 {
                font-size: 12px;
                margin-bottom: 8px;
            }

            .camera-content {
                padding: 0px;
            }

            .camera-popup iframe {
                /* max-width: 880px; */
                min-height: 420px;
                transform: scale(0.17);
                transform-origin: 0 0;
                height: 100vw;
                width: 2000px;
                height: 1110px;
                margin: 8px;
            }

            .leaflet-popup-content {
                margin: 8px;
                min-width: 260px;
                max-width: 90vw;
            }

            .camera-icon {
                transform: scale(0.8);
            }
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            color: #333;
            z-index: 1000;
        }

        #loading-bar-parent {
            width: 100%;
            position: relative;
            margin-bottom: -5px;
        }

        #loading-bar {
            position: absolute;
            top: 0;
            left: 0;
            height: 3px;
            /* altura igual ao do YouTube */
            width: 0;
            background: #3a7bf3;
            /* cor da barrinha, estilo YouTube */
            z-index: 9999;
            transition: width 0.2s ease-out;
        }
    </style>
</head>

<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MP4339CX" height="0" width="0"
            style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
    <header>
        <div class="vbox">
            <h1>
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="white">
                    <path
                        d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z" />
                </svg>
                RioCameras
            </h1>
            <div class="info" id="camera-count">Carregando...</div>
        </div>
        <a href="https://github.com/rbravo/riocameras" target="_blank" class="github-link" title="Ver no GitHub">
            <svg viewBox="0 0 16 16" fill="currentColor">
                <path
                    d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z" />
            </svg>
            <span>GitHub</span>
        </a>
    </header>

    <div class="bairro-selector">
        <select id="bairro-select">
            <option value="">游늸 Centralizar em um bairro:</option>
        </select>
    </div>

    <div id="loading" class="loading">Carregando c칙meras...</div>
    <div id="map"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        function startLoadingBar() {
            const bar = document.getElementById("loading-bar");
            // Define que em 5s ela deve chegar a 100%
            bar.style.transition = "width 5s linear";
            requestAnimationFrame(() => {
                bar.style.width = "100%";
            });
        }
        function finishLoadingBar() {
            const bar = document.getElementById("loading-bar");
            bar.style.transition = "all 0.3s ease-out";
            bar.style.width = "100%";
            // depois some suavemente
            setTimeout(() => {
                bar.style.opacity = "0";
            }, 400);
            setTimeout(() => {
                bar.remove();
            }, 800);
        }

        // Inicializar o mapa centrado no Rio de Janeiro
        const map = L.map('map').setView([-22.9997404, -43.3659929], 14);

        // Adicionar camada de tiles do OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);

        // 칈cone customizado para as c칙meras
        const cameraIcon = L.divIcon({
            className: 'camera-icon',
            html: '<svg xmlns="http://www.w3.org/2000/svg" style="margin:5px;" width="24" height="24" viewBox="0 0 24 24" fill="white"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/></svg>',
            iconSize: [40, 40],
            iconAnchor: [20, 20],
            popupAnchor: [0, -20]
        });

        // Buscar dados dos bairros
        fetch('/api/bairros')
            .then(response => response.json())
            .then(bairros => {
                const select = document.getElementById('bairro-select');

                // Ordenar bairros alfabeticamente
                bairros.sort((a, b) => a.nome.localeCompare(b.nome));

                // Adicionar op칞칫es ao select
                bairros.forEach(bairro => {
                    const option = document.createElement('option');
                    option.value = JSON.stringify({ lat: bairro.latitude, lon: bairro.longitude });
                    option.textContent = bairro.nome;
                    select.appendChild(option);
                });

                // Adicionar evento de mudan칞a
                select.addEventListener('change', (e) => {
                    if (e.target.value) {
                        const { lat, lon } = JSON.parse(e.target.value);
                        map.setView([lat, lon], 15, {
                            animate: true,
                            duration: 1
                        });
                    }
                });
            })
            .catch(error => {
                console.error('Erro ao carregar bairros:', error);
            });

        // Buscar dados das c칙meras
        fetch('/api/cameras')
            .then(response => response.json())
            .then(data => {
                // Remover mensagem de loading
                document.getElementById('loading').style.display = 'none';

                // Adicionar marcadores para cada c칙mera
                data.cameras.forEach(camera => {
                    const lat = parseFloat(camera.lat);
                    const lon = parseFloat(camera.lon);

                    if (!isNaN(lat) && !isNaN(lon)) {
                        const marker = L.marker([lat, lon], { icon: cameraIcon }).addTo(map);

                        // Criar popup com placeholder inicial
                        const popupPlaceholder = `
                            <div class="camera-popup">
                                <h3>#${camera.id} - ${camera.nome}</h3>
                                <div id="camera-content-${camera.id}" class="camera-content">
                                    <p>Carregando c칙mera...</p>
                                </div>
                            </div>
                        `;

                        const popup = L.popup({
                            maxWidth: 650,
                            minWidth: 320
                        }).setContent(popupPlaceholder);

                        marker.bindPopup(popup);

                        // Fun칞칚o para carregar o conte칰do da c칙mera
                        const loadCameraContent = async (cameraId, cameraUrl) => {
                            // Buscar o contentDiv toda vez que a fun칞칚o 칠 chamada
                            const contentDiv = document.getElementById(`camera-content-${cameraId}`);
                            if (!contentDiv) {
                                console.error(`ContentDiv n칚o encontrado para c칙mera ${cameraId}`);
                                return;
                            }

                            // Fun칞칚o para mostrar erro
                            const showError = (statusCode, statusText = '') => {
                                const errorMessages = {
                                    '400': 'Requisi칞칚o inv치lida (400 Bad Request)',
                                    '404': 'C칙mera n칚o encontrada (404)',
                                    '500': 'Erro no servidor (500)',
                                    '502': 'Servidor indispon칤vel (502)',
                                    '503': 'Servi칞o indispon칤vel (503)',
                                    'timeout': 'Tempo limite excedido',
                                    'network': 'Erro de conex칚o'
                                };

                                const message = errorMessages[statusCode] || `C칙mera indispon칤vel (${statusCode || 'erro'})`;

                                contentDiv.innerHTML = `
                                    <div style="text-align: center; padding: 30px 20px;">
                                        <p style="color: #d32f2f; margin-bottom: 10px; font-weight: bold;">丘멆잺 ${message}</p>
                                        <p style="font-size: 14px; color: #666; margin-bottom: 15px;">
                                            Esta c칙mera pode estar temporariamente fora do ar.
                                        </p>
                                        <button id="retry-btn-${cameraId}" 
                                            style="background: #1f54b8; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; margin-right: 10px;">
                                            Tentar novamente
                                        </button>
                                        <a href="${cameraUrl}" target="_blank"
                                            style="display: inline-block; background: #666; color: white; text-decoration: none; padding: 10px 20px; border-radius: 6px; font-size: 14px;">
                                            Abrir em nova aba
                                        </a>
                                    </div>
                                `;

                                // Adicionar event listener ao bot칚o de retry
                                setTimeout(() => {
                                    const retryBtn = document.getElementById(`retry-btn-${cameraId}`);
                                    if (retryBtn) {
                                        retryBtn.addEventListener('click', (e) => {
                                            e.preventDefault();
                                            e.stopPropagation();
                                            loadCameraContent(cameraId, cameraUrl);
                                        });
                                    }
                                }, 100);
                            };

                            try {
                                // Mostrar loading
                                contentDiv.innerHTML = `
                                    <div style="padding: 40px 20px; color: #666; text-align: center;">
                                        <p>Verificando disponibilidade da c칙mera...</p>
                                    </div>
                                `;

                                // Fazer fetch para verificar o status da URL
                                const controller = new AbortController();
                                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 segundos timeout

                                try {
                                    const response = await fetch(cameraUrl, {
                                        method: 'GET',
                                        signal: controller.signal
                                    });

                                    clearTimeout(timeoutId);

                                    // Verificar o status code
                                    if (!response.ok) {
                                        console.log(`C칙mera ${cameraId}: Status ${response.status}`);
                                        showError(response.status.toString(), response.statusText);
                                        return;
                                    }

                                    // Se chegou aqui, a c칙mera est치 dispon칤vel, carregar o iframe
                                    contentDiv.innerHTML = `
                                        <a href="${cameraUrl}" 
                                            style="padding-bottom: 8px; display: block;" target="_blank">Abrir em uma nova aba</a>
                                        <div id="loading-bar-parent">
                                            <div id="loading-bar"></div>
                                        </div>
                                        <iframe 
                                            src="${cameraUrl}" 
                                            frameborder="0"
                                            allowfullscreen>
                                        </iframe>
                                    `;
                                    if(window.timeoutBarId1){
                                        clearTimeout(window.timeoutBarId1);
                                    }
                                    window.timeoutBarId1 = setTimeout(() => {
                                        startLoadingBar();
                                        if (window.timeoutBarId) {
                                            clearTimeout(window.timeoutBarId);
                                        }
                                        window.timeoutBarId = setTimeout(() => {
                                            finishLoadingBar();
                                        }, 5000);
                                    }, 150);

                                } catch (fetchError) {
                                    clearTimeout(timeoutId);

                                    if (fetchError.name === 'AbortError') {
                                        console.log(`C칙mera ${cameraId}: Timeout`);
                                        showError('timeout');
                                    } else {
                                        console.log(`C칙mera ${cameraId}: Erro de rede`, fetchError);
                                        showError('network');
                                    }
                                }

                            } catch (error) {
                                console.error('Erro ao verificar c칙mera:', error);
                                showError('network');
                            }
                        };

                        // Quando o popup abrir, verificar se a c칙mera est치 dispon칤vel
                        marker.on('popupopen', async () => {
                            loadCameraContent(camera.id, `https://aplicativo.cocr.com.br/camera/${camera.id}`);
                        });
                    }
                });

                console.log(`${data.cameras.length} c칙meras carregadas no mapa`);

                // Atualizar contador no header
                document.getElementById('camera-count').textContent = `${data.cameras.length} c칙meras dispon칤veis`;
            })
            .catch(error => {
                console.error('Erro ao carregar c칙meras:', error);
                document.getElementById('loading').textContent = 'Erro ao carregar c칙meras';
                document.getElementById('camera-count').textContent = 'Erro ao carregar';
            });
    </script>
</body>

</html>